# MarkupCoreSamples

## Описание проекта

Этот проект представляет собой первый этап создания системы автоматического определения геологической породы по фото и предназначен для автоматической разметки изображений кернов и подготовки данных для обучения нейронной сети, которая определяет области кернов на изображениях. Проект включает инструменты для обработки изображений, выделения ключевых областей и генерации аннотаций в формате YOLO.

Основной принцип работы:
1) Использовать преобразование Хаффа для определения прямых линий на изображении
2) Предположить, что большие скопления прямых горизонтальных линий означают границы деревянного ящика в котором лежит керн
3) Сформировать кластеры линий, для определения границ ящика
4) Выбрать верхнюю/нижную границу кластера, как границу керна
5) Вычислить прямоугольника на изображении, которые содержат в себе керн
6) Записать полученные прямоугольники в файл в формате аннотаций YOLO.
7) Дополнительно вручную обработать и очистить полученные результаты при помощи утилиты `labelImg`

---

## Структура проекта
```
MarkupCoreSamples/
├── output/
│   ├── images/
│   │   └── train/         # Папка для изображений, на которых проводится разметка
│   ├── labels/
│   │   └── train/         # Папка для аннотаций в формате YOLO
├── input/                 # Исходные изображения
├── drill_core_process.py  # Класс для обработки данных
├── main.py                # Основной файл запуска алгоритма
├── points_clusterer.py    # Тестовые скрипты
```

---

## Схема работы алгоритма

### Блок-схема

```plaintext
+----------------------+            
| Start: Load Dataset |            
+----------------------+            
            |                       
            v                       
+---------------------------+       
| Determine Max Side        |       
| (find_max_side)           |       
+---------------------------+       
            |                       
            v                       
+-------------------------------+   
| Initialize DrillCoreProcess  |   
| (images_path)                |   
+-------------------------------+   
            |                       
            v                       
+-------------------------+         
| Process Images          |         
| (process_images)        |         
+-------------------------+         
            |                       
            v                       
+-------------------------------+   
| Preprocess Image             |   
| (Crop & Detect Edges)        |   
+-------------------------------+   
            |                       
            v                       
+-------------------------------+   
| Detect Horizontal Lines      |   
| (Hough Transform)            |   
+-------------------------------+   
            |                       
            v                       
+---------------------------+       
| Cluster Lines             |       
| (Group Close Lines)       |       
+---------------------------+       
            |                       
            v                       
+--------------------------------+  
| Extract Core Areas             |  
| (Generate Bounding Boxes)      |  
+--------------------------------+  
            |                       
            v                       
+----------------------------+      
| Save Annotations           |      
| (YOLO Format)              |      
+----------------------------+      
            |                       
            v                       
+-------------------------------+   
| Save Processed Image         |   
| (for Debugging)              |   
+-------------------------------+   
```

---

## Основные файлы

### main.py
Основной файл, содержащий функции:
- `find_max_side`: Определяет максимальный размер стороны среди изображений в директории.
- `main`: Запускает процесс разметки, инициализируя класс `DrillCoreProcess` и обрабатывая изображения.

### lib/drill_core_process.py
Класс `DrillCoreProcess`, включающий:
- Методы для предварительной обработки изображений (обрезка, выделение границ).
- Обнаружение горизонтальных линий с помощью преобразования Хафа.
- Кластеризация линий для выделения областей, содержащих керн.
- Генерация аннотаций в формате YOLO и сохранение результатов.

---

## Установка

1. Убедитесь, что установлен Python 3.8 или выше.
2. Установите зависимости:
```bash
pip install -r requirements.txt
```

---

## Использование

### Подготовка данных
1. Разместите изображения в папке `input`.
2. Для отладки разместите изобраения  в папке `test_input`.

### Запуск алгоритма
Для запуска основной программы выполните:
```bash
python main.py
```
Используйте для отладки ключ debug
```bash
python main.py --debug
```
---

## Формат аннотаций
Аннотации сохраняются в формате YOLO в папке `output/images` и `output/labels`:
- Каждая строка файла содержит класс и нормализованные координаты ограничивающей рамки (bounding box):
  ```
  <class_id> <x_center> <y_center> <width> <height>
  ```

---
## Результат работы

Выполните для просмотра результаты работы и откорректируйте найденные области кернов, 
чтобы подготовить данные для второго шага - обучения нейросети для автоматического обнаружения кернов на любой фотографии ящика
```
labelImg output/images/train output/labels/train/classes.txt
```

Для дебага (тестовые данные заранее включены в проект)
```
labelImg test_output/images/train test_output/labels/train/classes.txt
```

---

## TODO
- [ ] Добавить поддержку других форматов аннотаций (например, Pascal VOC).
- [ ] Оптимизировать поиск горизонтальных линий для улучшения качества кластеризации.
- [ ] Добавить конфигурационные файлы с настройками
